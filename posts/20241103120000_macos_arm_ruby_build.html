<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troubleshooting Version Managers on macOS (Apple Silicon & Intel)</title>
    <meta name="description" content="A comprehensive guide to troubleshooting Ruby and Node.js version managers on macOS, covering rbenv, RVM, nodenv, nvm, asdf, and mise. Learn about common issues and solutions for both Apple Silicon and Intel Macs.">
    <meta name="keywords" content="ruby, node.js, rbenv, rvm, nodenv, nvm, asdf, mise, macos, apple silicon, m1, m2, homebrew, openssl, rosetta">
    <meta name="author" content="Åndrei Makarov">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Troubleshooting Version Managers on macOS (Apple Silicon & Intel)">
    <meta property="og:description" content="A comprehensive guide to troubleshooting Ruby and Node.js version managers on macOS, covering common issues and solutions.">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://amkisko.github.io/posts/20241103120000_macos_arm_ruby_build.html">
    <meta property="article:published_time" content="2024-11-03T12:00:00+00:00">
    <meta property="article:modified_time" content="2024-11-03T12:00:00+00:00">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Troubleshooting Version Managers on macOS (Apple Silicon & Intel)">
    <meta name="twitter:description" content="A comprehensive guide to troubleshooting Ruby and Node.js version managers on macOS, covering common issues and solutions.">
    <link rel="stylesheet" href="../styles/posts_text.css">
    <link rel="stylesheet" href="../styles/posts_navigation.css">
</head>
<body>
    <a href="../posts.html" id="map-link" title="Map"></a>
    <article>
        <h1>Troubleshooting Version Managers on macOS (Apple Silicon & Intel)</h1>
        <div class="date">November 3, 2024</div>

        <p>Using Ruby and Node.js version managers on macOS can be tricky, especially with the transition to Apple Silicon (M1/M2) processors. This guide covers common issues and solutions for rbenv, RVM, nodenv, nvm, asdf, and mise on both ARM and Intel Macs.</p>

        <h2>Common Issues with Version Managers</h2>
        <p>Version managers on macOS often face several challenges:</p>
        <ul>
            <li><strong>Architecture mismatches:</strong> Apple Silicon Macs use ARM architecture. While older software was built for Intel (x86_64), it's recommended to use native ARM versions whenever possible rather than relying on emulation.</li>
            <li><strong>OpenSSL dependencies:</strong> Ruby and Node builds often need specific OpenSSL versions, which can be tricky to configure correctly.</li>
            <li><strong>Compilation flags:</strong> Older versions may need special compiler flags to build on modern macOS.</li>
            <li><strong>Homebrew paths:</strong> Different paths for ARM (<code>/opt/homebrew</code>) vs Intel (<code>/usr/local</code>) can cause confusion.</li>
        </ul>

        <h2>Homebrew and Native ARM Configuration</h2>
        <p>The first step in troubleshooting is ensuring correct Homebrew setup for ARM:</p>
        <ul>
            <li><strong>Use native ARM Homebrew:</strong> On Apple Silicon, ensure you're using the ARM version of Homebrew in <code>/opt/homebrew</code>. If you have Intel Homebrew in <code>/usr/local</code>, remove it to avoid conflicts.</li>
            <li><strong>Avoid Rosetta and arch commands:</strong> Instead of using Rosetta 2 or architecture switching, prefer native ARM versions of software. For older versions that don't support ARM, consider using newer versions that do.</li>
            <li><strong>Install native dependencies:</strong> Ensure <code>openssl</code>, <code>readline</code>, <code>libffi</code>, and other build tools are installed via ARM Homebrew.</li>
            <li><strong>Check brew config:</strong> Run <code>brew config</code> to verify you're using the native ARM version.</li>
        </ul>

        <h2>Ruby Version Managers (rbenv, RVM)</h2>
        <p>Ruby version managers need special attention on Apple Silicon. While rbenv is the recommended modern solution, some developers still use RVM (though it's considered legacy and not recommended for new projects).</p>

        <h3>rbenv/ruby-build</h3>
        <p>For rbenv users (the recommended approach), OpenSSL configuration is crucial:</p>
        <ul>
            <li>Ruby ≥3.1: Use OpenSSL 3 (<code>brew install openssl@3</code>)</li>
            <li>Ruby 2.4–3.0: Use OpenSSL 1.1 (<code>brew install openssl@1.1</code>)</li>
            <li>Export configuration:
<pre><code>export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@3)"  # For Ruby ≥3.1
# OR
export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@1.1)"  # For Ruby 2.4-3.0</code></pre>
            </li>
            <li>Alternative approach - vendored OpenSSL:
                <ul>
                    <li>Set <code>RUBY_BUILD_VENDOR_OPENSSL=1</code> to force ruby-build to compile and vendor its own OpenSSL</li>
                    <li>This can help avoid system OpenSSL compatibility issues</li>
                    <li>Takes longer to build but provides more consistent results across different environments</li>
                    <li>Particularly useful when system OpenSSL causes unexpected issues or when you need a specific OpenSSL version</li>
                </ul>
            </li>
        </ul>

        <h3>RVM Configuration (Legacy)</h3>
        <p>While RVM is an older solution and not recommended for new projects due to its invasive shell integration and complexity, some legacy projects still use it. If you must use RVM, here's how to configure it:</p>
        <p>RVM users should point to Homebrew's OpenSSL:</p>
<pre><code>rvm reinstall 3.3.0 --with-openssl-dir=$(brew --prefix openssl@3)
# For older Ruby versions:
rvm reinstall 2.7.2 --with-openssl-dir=$(brew --prefix openssl@1.1)</code></pre>

        <h2>Node Version Managers (nodenv, nvm)</h2>
        <p>Node.js version managers have their own considerations. While nodenv is the recommended modern solution following rbenv's proven design, nvm is an older alternative that some projects still use.</p>

        <h3>nodenv Configuration (Recommended)</h3>
        <p>nodenv works similarly to rbenv and is the preferred solution:</p>
        <ul>
            <li>Install latest OpenSSL and pkg-config via Homebrew</li>
            <li>Use Rosetta for older Node versions</li>
            <li>Set appropriate OpenSSL flags if needed</li>
            <li>Supports version override via <code>NODENV_VERSION</code> environment variable</li>
            <li>Can be installed via Homebrew: <code>brew install nodenv</code></li>
            <li>Uses <code>node-build</code> plugin for installing Node versions</li>
            <li>Automatically reads <code>.node-version</code> files in project directories</li>
            <li>Follows rbenv's lightweight design principles:
                <ul>
                    <li>Minimal shell integration</li>
                    <li>Project-specific version files</li>
                    <li>Simple and predictable behavior</li>
                </ul>
            </li>
        </ul>

        <h3>nvm Setup (Legacy)</h3>
        <p>nvm is an older solution with some drawbacks:</p>
        <ul>
            <li>Heavy shell integration that can slow down shell startup</li>
            <li>More complex configuration and maintenance</li>
            <li>Not recommended for new projects</li>
            <li>If you must use it (e.g., legacy projects):
                <ul>
                    <li>Use Node ≥15 which has native ARM support</li>
                    <li>For projects requiring Node ≤14, strongly consider upgrading to a newer Node version with ARM support</li>
                    <li>Avoid Homebrew installation of nvm - use the official install script</li>
                </ul>
            </li>
        </ul>

        <h2>Multi-Runtime Managers (asdf, mise)</h2>
        <p>Modern multi-runtime version managers offer unified solutions, with different approaches to version management:</p>

        <h3>asdf</h3>
        <ul>
            <li>Uses plugins for each runtime (Ruby, Node.js, etc.)</li>
            <li>Ruby plugin wraps ruby-build (same configuration applies)</li>
            <li>Node.js plugin handles architecture switching automatically</li>
            <li>Supports <code>.tool-versions</code> for project-specific versions</li>
        </ul>

        <h3>mise (formerly rtx)</h3>
        <ul>
            <li>Built-in support for Ruby and Node.js</li>
            <li>Automatic architecture switching for older Node versions</li>
            <li>Supports multiple version file formats (<code>.tool-versions</code>, <code>.ruby-version</code>, <code>.nvmrc</code>)</li>
            <li>Manages its own copies of build tools</li>
            <li>Uses a different approach for version overrides:
                <ul>
                    <li>Uses <code>mise use ruby@version</code> for temporary switches</li>
                    <li>Supports <code>mise set ruby@version</code> for persistent changes</li>
                    <li>Environment overrides through <code>MISE_*</code> variables work differently than rbenv/nodenv</li>
                </ul>
            </li>
        </ul>

        <h2>Environment Variables and Shell Setup</h2>
        <p>Proper shell configuration is essential:</p>

        <h3>Common Environment Variables</h3>
<pre><code># For Ruby builds
export RUBY_CFLAGS="-Wno-error=implicit-function-declaration"
export LDFLAGS="-L$(brew --prefix readline)/lib"
export CPPFLAGS="-I$(brew --prefix readline)/include"

# For older Ruby versions
export optflags="-Wno-error=implicit-function-declaration"
export LDFLAGS="-L$(brew --prefix libffi)/lib"
export CPPFLAGS="-I$(brew --prefix libffi)/include"</code></pre>

        <h3>Shell Initialization</h3>
        <ul>
            <li>rbenv: Add <code>eval "$(rbenv init - zsh)"</code> to <code>.zshrc</code></li>
            <li>RVM: Include <code>source ~/.rvm/scripts/rvm</code></li>
            <li>nvm: Add NVM directory and source script</li>
            <li>asdf: Add shims to PATH and enable completions</li>
            <li>mise: Ensure <code>~/.local/bin</code> is in PATH</li>
        </ul>

        <h2>Best Practices and Tips</h2>
        <ul>
            <li><strong>Use native ARM builds:</strong> Always prefer native ARM versions of software. Avoid using Rosetta 2 or architecture switching commands.</li>
            <li><strong>Keep tools updated:</strong> Regularly update version managers and their plugins/definitions to get the latest ARM support.</li>
            <li><strong>Document configuration:</strong> Maintain team documentation about required environment setup.</li>
            <li><strong>Version pinning:</strong> Use version files (<code>.ruby-version</code>, <code>.nvmrc</code>, <code>.tool-versions</code>) in projects.</li>
            <li><strong>CI/CD consideration:</strong> Ensure CI/CD pipelines use ARM runners when deploying to ARM environments.</li>
            <li><strong>Upgrade legacy projects:</strong> If working with older projects, prioritize upgrading to versions with native ARM support rather than using emulation.</li>
        </ul>

        <h2>Conclusion</h2>
        <p>Successfully managing Ruby and Node.js versions on macOS requires embracing native ARM support and avoiding emulation layers. By using modern versions with ARM support and following these guidelines, developers can maintain a fast, efficient development environment on Apple Silicon Macs.</p>

        <div class="references">
            <h3>References</h3>
            <ul>
                <li><a href="https://github.com/rbenv/ruby-build/wiki">ruby-build Wiki</a></li>
                <li><a href="https://rvm.io/integration/osx">RVM on macOS Guide</a></li>
                <li><a href="https://github.com/nvm-sh/nvm#installing-and-updating">NVM Installation Guide</a></li>
                <li><a href="https://asdf-vm.com/guide/getting-started.html">asdf Getting Started Guide</a></li>
                <li><a href="https://mise.jdx.dev/tips-and-tricks.html">mise Tips and Tricks</a></li>
            </ul>
        </div>
    </article>
    <a href="#" id="to-top" title="To the top"></a>

    <script src="../scripts/posts_navigation.js"></script>
</body>
</html>